<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="General description"><title>massa_versioning - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-c5d6553a23f1e5a6.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="massa_versioning" data-themes="" data-resource-suffix="" data-rustdoc-version="1.81.0 (eeb90cda1 2024-09-04)" data-channel="1.81.0" data-search-js="search-d234aafac6c221dd.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-d2fab2bf619172d3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-df360f571f6edeae.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../massa_versioning/index.html">massa_versioning</a><span class="version">2.4.0</span></h2></div><div class="sidebar-elems"><ul class="block"><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#modules">Modules</a></li></ul></section></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">massa_versioning</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../src/massa_versioning/lib.rs.html#3-97">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="general-description"><a class="doc-anchor" href="#general-description">§</a>General description</h2>
<p>MIP = Massa Improvement proposal (similar to Bitcoin Improvement Proposal - BIP or Ethereum - EIP)</p>
<p>MipComponent -&gt; A component that is going to be updated (e.g. Address v2)
MIPInfo -&gt; represent a MIP (name, versions, time ranges, components)
MIPState -&gt; Deployment state of a MIPInfo
MIPStore -&gt; A map of MIPInfo -&gt; MipState</p>
<p>Check massa-versioning/src/mips.rs file for a list of already defined MIPInfo.</p>
<h2 id="notes-on-mipinfo-versions"><a class="doc-anchor" href="#notes-on-mipinfo-versions">§</a>Notes on MipInfo versions</h2>
<p>There is 2 different ‘versions’:</p>
<ul>
<li>version == Network version -&gt; This is the network version to announce and thus is stored in block header</li>
<li>component_version -&gt; This is the version for the associated component (stored in a MIPInfo) and is used in VersioningFactory (e.g. KeyPair, Address, VM)</li>
</ul>
<h2 id="notes-on-mipinfo-timings-and-stats"><a class="doc-anchor" href="#notes-on-mipinfo-timings-and-stats">§</a>Notes on MipInfo timings and stats</h2>
<p>MipStore stats is in fact a voting system. Node runners can agree on a new version (a new list of MIPInfo) by
updating their node software. If a majority of node runners do not update, the new version will be rejected.</p>
<p>So in the execution module and after a block become final, we update the MipStore stats (in a blocking way).
By updating the stats, we mean sending: (Slot timestamp, Option&lt;(current: u32, announced: Option)&gt;).
Using the slot timestamp, ensure that the trigger (and the trigger timeout) is a consensus by all nodes
(This means that the trigger and the trigger timeout are not timer based).
In order to have all nodes in sync (because of node various delays), the state is set to active
after an activation delay (duration is required to be &gt; 1 cycle).</p>
<p>About activation delay:</p>
<p>At the slot when the activation happens, need to make sure that everyone knows it should happen,
so we need to make sure that everyone has seen as final the slot that triggered the locked-in state,
and the worst-case delay required for a slot to become final is the definition of a cycle.</p>
<p>The activation delay counts how long we wait to activate after the vote threshold was reached,
and we entered into locked-in state. During that delay, and after it, the number of blocks considered
for the vote is not relevant. The only reason why we should consider a sufficient number of votes
is to get a reasonable p-value on the vote itself:</p>
<p>if we consider only 5 votes, the probability that a 30%-stake was selected to vote at least 75% of the times is 3%:
if we consider 1000 votes that probability falls to 1e-149.</p>
<h2 id="notes-on-mipstate"><a class="doc-anchor" href="#notes-on-mipstate">§</a>Notes on MipState</h2>
<p>MipState has:</p>
<ul>
<li>A state machine (stores the current state of deployment for a MipInfo)
<ul>
<li>Usual state changes: Defined -&gt; Started -&gt; LockedIn -&gt; Active</li>
</ul>
</li>
<li>A history (stores a list of <code>Advance</code> message that ‘really’ updated the state machine)</li>
</ul>
<p>An auto generated graph of the state machine can be found here:</p>
<ul>
<li>dot -Tpng ./target/machine/componentstate.dot &gt; ./target/machine/componentstate.png</li>
<li>xdg-open ./target/machine/componentstate.png</li>
</ul>
<p>History is there in order to:</p>
<ul>
<li>Query the state at any time, so you can query MipStore and ask the best version at any time</li>
<li>Used a lot when merging 2 MipStore:
<ul>
<li>By replaying the history of the states of the received MipStore (bootstrap), we can safely update in the bootstrap process</li>
<li>
<ul>
<li>When we initialize a MipStore (at startup), this ensures that we have a time ranges &amp; versions consistent list of MipInfo</li>
</ul>
<ul>
<li>For instance, this can avoid to have 2 MipInfo with the same name</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="versioning-factory"><a class="doc-anchor" href="#versioning-factory">§</a>Versioning Factory</h2>
<p>A Factory trait is there to ease the development of factory for Versioned component (e.g. address, block)</p>
<p>All factories should query MIPStore in order to create a component with correct version; default implementation
are provided by the trait to avoid re-writing these query functions.</p>
<p>Unit tests in versioning_factory.rs shows a basic but realistic implementation of a AddressFactory (impl the Factory trait)</p>
<h2 id="mipstore-and-final-state-hash"><a class="doc-anchor" href="#mipstore-and-final-state-hash">§</a>MipStore and Final state hash</h2>
<p>MipStore is written on disk after each block finalization. Writes are done in two separate column:</p>
<ul>
<li>STATE_CF: ‘Active’ MIP info list</li>
<li>VERSIONING_CF: other MIP info + stats</li>
</ul>
<p>By writing only ‘Active’ MIP in state_cf column, we ensure that the final state hash remains the same between
the versioning transition (e.g. User 1 has upgraded to network version 1 while User 2 has not yet upgraded)</p>
<h2 id="tests"><a class="doc-anchor" href="#tests">§</a>Tests</h2>
<p>The massa-versioning module has a bunch of unit test in versioning.rs. Note that functional test,
can be found in https://github.com/massalabs/massa-functional-tests/blob/main/tests_versioning.py.
Note that those tests might not be up to date with the latest module code.</p>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="address_factory/index.html" title="mod massa_versioning::address_factory">address_factory</a></div></li><li><div class="item-name"><a class="mod" href="grpc_mapping/index.html" title="mod massa_versioning::grpc_mapping">grpc_mapping</a></div></li><li><div class="item-name"><a class="mod" href="keypair_factory/index.html" title="mod massa_versioning::keypair_factory">keypair_factory</a></div></li><li><div class="item-name"><a class="mod" href="mips/index.html" title="mod massa_versioning::mips">mips</a></div></li><li><div class="item-name"><a class="mod" href="versioning/index.html" title="mod massa_versioning::versioning">versioning</a></div></li><li><div class="item-name"><a class="mod" href="versioning_factory/index.html" title="mod massa_versioning::versioning_factory">versioning_factory</a></div></li><li><div class="item-name"><a class="mod" href="versioning_ser_der/index.html" title="mod massa_versioning::versioning_ser_der">versioning_ser_der</a></div></li></ul></section></div></main></body></html>