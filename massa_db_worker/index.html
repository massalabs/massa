<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="General description"><title>massa_db_worker - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-c5d6553a23f1e5a6.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="massa_db_worker" data-themes="" data-resource-suffix="" data-rustdoc-version="1.81.0 (eeb90cda1 2024-09-04)" data-channel="1.81.0" data-search-js="search-d234aafac6c221dd.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-d2fab2bf619172d3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-df360f571f6edeae.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../massa_db_worker/index.html">massa_db_worker</a><span class="version">2.4.0</span></h2></div><div class="sidebar-elems"><ul class="block"><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#types">Type Aliases</a></li></ul></section></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">massa_db_worker</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../src/massa_db_worker/lib.rs.html#3-65">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="general-description"><a class="doc-anchor" href="#general-description">§</a>General description</h2>
<p>MassaDB is a wrapper around:</p>
<ul>
<li>A RocksDB database (on Disk)</li>
<li>Some caches (on RAM).</li>
<li>a config</li>
</ul>
<h2 id="rocksdb"><a class="doc-anchor" href="#rocksdb">§</a>RocksDB</h2>
<p>RocksDB stores keys and values, which are arbitrarily-sized byte streams (aka vec<u8> or &amp;<a href="https://doc.rust-lang.org/1.81.0/std/primitive.u8.html" title="primitive u8">u8</a>).
It supports both point lookups and range scans.</p>
<p>For MassaDB, we use 3 rocksdb column:</p>
<ul>
<li>state: all data for (async pool, executed ops/de, ledger …) and used to compute the db hash</li>
<li>versioning: partial MIP store data see Versioning doc section: “MipStore and Final state hash”</li>
<li>metadata: final state hash + slot</li>
</ul>
<p>Note that data is stored with a prefix (see constants.rs in massa-db-exports).
For instance, a ledger update, will be stored (in column: ‘state’) as:</p>
<ul>
<li>key: LEDGER_PREFIX+Address+[…] (serialized as bytes)</li>
<li>value: Amount (serialized as bytes)</li>
</ul>
<p>Note: prefixes are used to separate data between sub systems of final state
(async pool, executed ops/de, ledger…)</p>
<h2 id="db-hash"><a class="doc-anchor" href="#db-hash">§</a>DB hash</h2>
<p>Whenever something is stored on the column ‘state’, the db hash is updating using Xor.
This allows for fast hash updates when adding or deleting an item in the db.</p>
<p>if we have item a = 0b0011 et item b = Ob1011:</p>
<ul>
<li>hash will be: 0011 ^ 1011 == 1011 ^ 0011 == 1000 (insert order independent)</li>
<li>if we want to delete item a: 1000 ^ 0011 == 1011 (== item b)</li>
<li>if we want to delete item b: 1000 ^ 1011 == 0011 (== item a)</li>
</ul>
<p>Note that this does not provides “Proof of present” nor “Proof of Absence”
(operations avail with Merkle trees)</p>
<p>For more details here: https://github.com/massalabs/massa/discussions/3852#discussioncomment-6188158</p>
<p>This hash is often referred as ‘final state hash’.</p>
<h2 id="caches"><a class="doc-anchor" href="#caches">§</a>Caches</h2>
<p>A cache of db changes is kept in memory allowing to easily stream it
(by streaming, we means: sending it to another massa node (aka bootstrap))
There is 2 separate caches: one for ‘state’ and one for ‘versioning’</p>
<p>These caches is stored as a key, value: slot -&gt; insertion_data|deletion_data.</p>
<h2 id="streaming-steps"><a class="doc-anchor" href="#streaming-steps">§</a>Streaming steps</h2>
<p>1- Streaming always starts by reading data from disk (from rocksdb). Data is send by chunk.
2- As this process can be slow (e.g. db size is high, network is slow), updates can happen simultaneously
(as new slots are processed by the node, data can be updated)
thus the (DB) caches are updated so as the streaming process is ongoing, we can easily only send
the updates (by querying only the cache)
3- Even after this process is finished (and as other things like consensus data are streamed),
we can send the updates</p>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="massa_db/index.html" title="mod massa_db_worker::massa_db">massa_db</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li></ul><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.RawMassaDB.html" title="struct massa_db_worker::RawMassaDB">RawMassaDB</a></div><div class="desc docblock-short">A generic wrapped RocksDB database.</div></li></ul><h2 id="types" class="section-header">Type Aliases<a href="#types" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="type" href="type.MassaDB.html" title="type massa_db_worker::MassaDB">MassaDB</a></div><div class="desc docblock-short">Wrapped RocksDB database</div></li></ul></section></div></main></body></html>